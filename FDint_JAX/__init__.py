import jax
import jax.numpy as jnp
from jax.scipy.special import gamma

def _fukushima_fdi_m0p5_region_1(x):
    y = jnp.exp(x)
    t = y * 7.38905609893065023
    return y * (0.564189583547756287 + y * (112.834833932499389 + t * (10.9633343533731491 + t * (0.256367244914438769 + t * 0.000816738513302306131))) / (201.169741622421321 + t * (30.4925345821351213 + t * (1.0 + t * 0.0001))))

def _fukushima_fdi_m0p5_region_2(x):
    s = -0.5 * x
    t = 1.0 - s
    return (10.0033751334425838 + t * (-1.31258144343989837 + t * (1.01179428010843293 + t * (2.01653180431130952 + t * (0.713893115379915668 + t * (-0.0905734815435121063 + t * (-0.0813393899985648525 - t * (0.0141359131077995633 + t * 0.000399033348803994913)))))))) / (17.7049061309991933 + s * (20.4494259040339612 + s * (18.0739294535215361 + s * (11.5432980184532321 + s * (5.11360421199500393 + s * (1.68994445505313333 + s * (0.378211899531317361 + s)))))))

def _fukushima_fdi_m0p5_region_3(x):
    t = 0.5 * x
    return (3531.50360568243046 + t * (6077.5339658420037 + t * (6199.7700433981326 + t * (4412.78701919567594 + t * (2252.27343092810898 + t * (811.84098649224085 + t * (191.836401053637121 + t * 23.2881838959183802))))))) / (3293.83702584796268 + t * (1528.97474029789098 + t * (2568.48562814986046 + t * (925.64264653555825 + t * (574.23248354035988 + t * (132.803859320667262 + t * (29.8447166552102115 + t)))))))

def _fukushima_fdi_m0p5_region_4(x):
    t = (x - 2.0) / 3.0
    return (4060.70753404118265 + t * (10812.7291333052766 + t * (13897.5649482242583 + t * (10628.4749852740029 + t * (5107.70670190679021 + t * (1540.84330126003381 + t * (284.452720112970331 + t * 29.5214417358484151))))))) / (1564.58195612633534 + t * (2825.75172277850406 + t * (3189.16066169981562 + t * (1955.03979069032571 + t * (828.000333691814748 + t * (181.498111089518376 + t * (32.0352857794803750 + t)))))))

def _fukushima_fdi_m0p5_region_5(x):
    t = 0.2 * x - 1.0
    return (1198.41719029557508 + t * (3263.51454554908654 + t * (3874.97588471376487 + t * (2623.13060317199813 + t * (1100.41355637121217 + t * (267.469532490503605 + t * (25.4207671812718340 + t * 0.389887754234555773))))))) / (273.407957792556998 + t * (595.918318952058643 + t * (605.202452261660849 + t * (343.183302735619981 + t * (122.187622015695729 + t * (20.9016359079855933 + t))))))

def _fukushima_fdi_m0p5_region_6(x):
    t = 0.1 * x - 1.0
    return (9446.00169435237637 + t * (36843.4448474028632 + t * (63710.1115419926191 + t * (62985.2197361074768 + t * (37634.5231395700921 + t * (12810.9898627807754 + t * (1981.56896138920963 + t * 81.4930171897667580))))))) / (1500.04697810133666 + t * (5086.91381052794059 + t * (7730.01593747621895 + t * (6640.83376239360596 + t * (3338.99590300826393 + t * (860.499043886802984 + t * (78.8565824186926692 + t)))))))

def _fukushima_fdi_m0p5_region_7(x):
    t = 0.05 * x - 1.0
    return (22977.9657855367223 + t * (123416.616813887781 + t * (261153.765172355107 + t * (274618.894514095795 + t * (149710.718389924860 + t * (40129.3371700184546 + t * (4470.46495881415076 + t * 132.684346831002976))))))) / (2571.68842525335676 + t * (12521.4982290775358 + t * (23268.1574325055341 + t * (20477.2320119758141 + t * (8726.52577962268114 + t * (1647.42896896769909 + t * (106.475275142076623 + t)))))))

def _fukushima_fdi_m0p5_region_8(x):
    factor = 2.0
    w = 1.0 / (x * x)
    t = 1600.0 * w
    return jnp.sqrt(x) * factor * (1.0 - w * (0.411233516712009968 + t * (0.00110980410034088951 + t * (0.0000113689298990173683 + t * (2.56931790679436797e-7 + t * (9.97897786755446178e-9 + t * 8.67667698791108582e-10))))))

def FD_minus_half(x):
    x1 = -2.0
    x2 = 0.0
    x3 = 2.0
    x4 = 5.0
    x5 = 10.0
    x6 = 20.0
    x7 = 40.0

    # The Fortran code uses a series of if/else if statements.
    # jax.lax.select is not ideal for this, as it only supports one condition.
    # Instead, we can use a series of where clauses, which is equivalent to
    # a series of if/else if statements.
    
    # An alternative is to use jax.lax.switch, but that requires integer indices.
    # We can create these indices from the conditions.
    
    index = jnp.sum(jnp.array([
        x < x1,
        x >= x1 and x < x2,
        x >= x2 and x < x3,
        x >= x3 and x < x4,
        x >= x4 and x < x5,
        x >= x5 and x < x6,
        x >= x6 and x < x7,
    ]))
    
    # The last condition is x >= x7, which is the default case.
    # The branches are indexed from 0 to 7.
    
    branches = [
        _fukushima_fdi_m0p5_region_1,
        _fukushima_fdi_m0p5_region_2,
        _fukushima_fdi_m0p5_region_3,
        _fukushima_fdi_m0p5_region_4,
        _fukushima_fdi_m0p5_region_5,
        _fukushima_fdi_m0p5_region_6,
        _fukushima_fdi_m0p5_region_7,
        _fukushima_fdi_m0p5_region_8,
    ]
    
    # We need to handle the case where x is an array.
    # We can use jax.lax.switch for this.
    
    # The problem is that the conditions are not mutually exclusive for arrays.
    # For example, if x = [-3, 1], then the first element is < x1 and the second is >= x2 and < x3.
    
    # A better way is to use jnp.select.
    
    conditions = [
        x < x1,
        (x >= x1) & (x < x2),
        (x >= x2) & (x < x3),
        (x >= x3) & (x < x4),
        (x >= x4) & (x < x5),
        (x >= x5) & (x < x6),
        (x >= x6) & (x < x7),
    ]
    
    functions = [
        _fukushima_fdi_m0p5_region_1,
        _fukushima_fdi_m0p5_region_2,
        _fukushima_fdi_m0p5_region_3,
        _fukushima_fdi_m0p5_region_4,
        _fukushima_fdi_m0p5_region_5,
        _fukushima_fdi_m0p5_region_6,
        _fukushima_fdi_m0p5_region_7,
    ]
    
    # jnp.select(conditions, functions) does not work because functions are not arrays.
    # We need to call the functions.
    
    results = [f(x) for f in functions]
    
    return jnp.select(conditions, results, default=_fukushima_fdi_m0p5_region_8(x)) / jnp.sqrt(jnp.pi)


@jax.custom_vjp
def fermi_dirac_integral_half(x):
    x1 = -2.0
    x2 = 0.0
    x3 = 2.0
    x4 = 5.0
    x5 = 10.0
    x6 = 20.0
    x7 = 40.0

    conditions = [
        x < x1,
        (x >= x1) & (x < x2),
        (x >= x2) & (x < x3),
        (x >= x3) & (x < x4),
        (x >= x4) & (x < x5),
        (x >= x5) & (x < x6),
        (x >= x6) & (x < x7),
    ]

    functions = [
        _fukushima_fdi_p0p5_region_1,
        _fukushima_fdi_p0p5_region_2,
        _fukushima_fdi_p0p5_region_3,
        _fukushima_fdi_p0p5_region_4,
        _fukushima_fdi_p0p5_region_5,
        _fukushima_fdi_p0p5_region_6,
        _fukushima_fdi_p0p5_region_7,
    ]

    results = [f(x) for f in functions]

    return jnp.select(conditions, results, default=_fukushima_fdi_p0p5_region_8(x)) / (0.5 * jnp.sqrt(jnp.pi))

def _fukushima_fdi_p0p5_region_1(x):
    y = jnp.exp(x)
    t = y * 7.38905609893065023
    return y * (0.886226925452758014 - y * (19894.4553386951666 + t * (4509.64329955948557 + t * (303.461789035142376 + t * (5.7574879114754736 + t * 0.00275088986849762610)))) / (63493.915041308052 + t * (19070.1178243603945 + t * (1962.19362141235102 + t * (79.250704958640158 + t)))))

def _fukushima_fdi_p0p5_region_2(x):
    s = -0.5 * x
    t = 1.0 - s
    return (149.462587768865243 + t * (22.8125889885050154 + t * (-0.629256395534285422 + t * (9.08120441515995244 + t * (3.35357478401835299 + t * (-0.473677696915555805 + t * (-0.467190913556185953 + t * (-0.0880610317272330793 - t * 0.00262208080491572673)))))))) / (269.94660938022644 + s * (343.6419926336247 + s * (323.9049470901941 + s * (218.89170769294024 + s * (102.31331350098315 + s * (36.319337289702664 + s * (8.3317401231389461 + s)))))))

def _fukushima_fdi_p0p5_region_3(x):
    t = 0.5 * x
    return (71652.717119215557 + t * (134954.734070223743 + t * (153693.833350315645 + t * (123247.280745703400 + t * (72886.293647930726 + t * (32081.2499422362952 + t * (10210.9967337762918 + t * (2152.71110381320778 + t * 232.906588165205042)))))))) / (105667.839854298798 + t * (31946.0752989314444 + t * (71158.788776422211 + t * (15650.8990138187414 + t * (13521.8033657783433 + t * (1646.98258283527892 + t * (618.90691969249409 + t * (-3.36319591755394735 + t))))))))

def _fukushima_fdi_p0p5_region_4(x):
    t = (x - 2.0) / 3.0
    return (23744.8706993314289 + t * (68257.8589855623002 + t * (89327.4467683334597 + t * (62766.3415600442563 + t * (20093.6622609901994 + t * (-2213.89084119777949 + t * (-3901.66057267577389 - t * 948.642895944858861))))))) / (9488.61972919565851 + t * (12514.8125526953073 + t * (9903.44088207450946 + t * (2138.15420910334305 + t * (-528.394863730838233 + t * (-661.033633995449691 + t * (-51.4481470250962337 + t)))))))

def _fukushima_fdi_p0p5_region_5(x):
    t = 0.2 * x - 1.0
    return (311337.452661582536 + t * (1.11267074416648198e6 + t * (1.75638628895671735e6 + t * (1.59630855803772449e6 + t * (910818.935456183774 + t * (326492.733550701245 + t * (65507.2624972852908 + t * 4809.45649527286889))))))) / (39721.6641625089685 + t * (86424.7529107662431 + t * (88163.7255252151780 + t * (50615.7363511157353 + t * (17334.9774805008209 + t * (2712.13170809042550 + t * (82.2205828354629102 - t))))))) * 0.999999999999999877

def _fukushima_fdi_p0p5_region_6(x):
    t = 0.1 * x - 1.0
    return (7.26870063003059784e6 + t * (2.79049734854776025e7 + t * (4.42791767759742390e7 + t * (3.63735017512363365e7 + t * (1.55766342463679795e7 + t * (2.97469357085299505e6 + t * 154516.447031598403)))))) / (340542.544360209743 + t * (805021.468647620047 + t * (759088.235455002605 + t * (304686.671371640343 + t * (39289.4061400542309 + t * (582.426138126398363 + t * (11.2728194581586028 - t)))))))

def _fukushima_fdi_p0p5_region_7(x):
    t = 0.05 * x - 1.0
    return (4.81449797541963104e6 + t * (1.85162850713127602e7 + t * (2.77630967522574435e7 + t * (2.03275937688070624e7 + t * (7.41578871589369361e6 + t * (1.21193113596189034e6 + t * 63211.9545144644852)))))) / (80492.7765975237449 + t * (189328.678152654840 + t * (151155.890651482570 + t * (48146.3242253837259 + t * (5407.08878394180588 + t * (112.195044410775577 - t))))))

def _fukushima_fdi_p0p5_region_8(x):
    factor = 2.0 / 3.0
    w = 1.0 / (x * x)
    s = 1.0 - 1600.0 * w
    return x * jnp.sqrt(x) * factor * (1.0 + w * (8109.79390744477921 + s * (342.069867454704106 + s * 1.07141702293504595)) / (6569.98472532829094 + s * (280.7064658516838090 + s)))

def fermi_dirac_integral_half_fwd(x):
    return fermi_dirac_integral_half(x), FD_minus_half(x)

def FD_half_bwd(res, g):
    return (res * g,)

fermi_dirac_integral_half.defvjp(fermi_dirac_integral_half_fwd, FD_half_bwd)


@jax.custom_vjp
def fermi_dirac_integral_three_half(x):
    x1 = -2.0
    x2 = 0.0
    x3 = 2.0
    x4 = 5.0
    x5 = 10.0
    x6 = 20.0
    x7 = 40.0

    conditions = [
        x < x1,
        (x >= x1) & (x < x2),
        (x >= x2) & (x < x3),
        (x >= x3) & (x < x4),
        (x >= x4) & (x < x5),
        (x >= x5) & (x < x6),
        (x >= x6) & (x < x7),
    ]

    functions = [
        _fukushima_fdi_p1p5_region_1,
        _fukushima_fdi_p1p5_region_2,
        _fukushima_fdi_p1p5_region_3,
        _fukushima_fdi_p1p5_region_4,
        _fukushima_fdi_p1p5_region_5,
        _fukushima_fdi_p1p5_region_6,
        _fukushima_fdi_p1p5_region_7,
    ]

    results = [f(x) for f in functions]

    return jnp.select(conditions, results, default=_fukushima_fdi_p1p5_region_8(x)) / (1.5 * 0.5 * jnp.sqrt(jnp.pi))

def _fukushima_fdi_p1p5_region_1(x):
    y = jnp.exp(x)
    t = y * 7.38905609893065023
    return y * (1.32934038817913702 - y * (1346.14119046566636 + t * (199.946876779712712 + t * (6.5210149677288048 + t * 0.0108588591982722183))) / (5728.3481201778541 + t * (1132.17837281710987 + t * (64.805243148002602 + t))))

def _fukushima_fdi_p1p5_region_2(x):
    s = -0.5 * x
    t = 1.0 - s
    return (631.667081787115831 + t * (504.131655805666135 + t * (113.449065431934917 + t * (56.0939647772947784 + t * (43.3374223200846752 + t * (12.8047010597109577 + t * (0.219164386586949410 + t * (-0.678659552658390139 - t * 0.126533769309899232)))))))) / (1180.5112183558028 + s * (1101.0159189871135 + s * (864.4448234404281 + s * (392.2018227840790 + s * (89.58093202779063 + s * (-9.95066218572899 + s * (-17.312068771997626 + s * (-6.4116162917822773 - s))))))))

def _fukushima_fdi_p1p5_region_3(x):
    t = 0.5 * x
    return (90122.488639370400 + t * (157095.208147064037 + t * (166879.962599668589 + t * (125708.597728045460 + t * (69968.278213181390 + t * (29035.3292989055404 + t * (8736.4439472398517 + t * (1747.16784760309227 + t * 180.132410666734053)))))))) / (78176.777123671727 + t * (-1681.44633240543085 + t * (38665.7913035496031 + t * (-2527.29685826087874 + t * (5062.6683078100048 + t * (-553.21165462054589 + t * (165.395637981775430 + t * (-18.0295465153725544 + t))))))))

def _fukushima_fdi_p1p5_region_4(x):
    t = (x - 2.0) / 3.0
    return (912944.432058014054 + t * (3.28217091334054338e6 + t * (5.59250227196369585e6 + t * (5.76136129685687470e6 + t * (3.84331519034749983e6 + t * (1.65284168824947710e6 + t * (423452.676670436605 + t * 49835.4127241373113))))))) / (164873.145721762182 + t * (257442.511191094986 + t * (225604.160532840884 + t * (99932.1955662320024 + t * (24761.0878784286761 + t * (1398.26392212830777 + t * (-36.4450237523474167 + t)))))))

def _fukushima_fdi_p1p5_region_5(x):
    t = 0.2 * x - 1.0
    return (1.88412548327216052e6 + t * (8.08838896259910792e6 + t * (1.56869793001790529e7 + t * (1.79109792599373447e7 + t * (1.31345142328147214e7 + t * (6.29500412046744325e6 + t * (1.89326213154091054e6 + t * (312372.643127575407 + t * 18814.7420442630170)))))))) / (67768.3347951202583 + t * (147635.914444221358 + t * (151908.303165069423 + t * (86671.1222110642970 + t * (27855.9481608626219 + t * (3833.22697473114940 + t * (98.3384567064269554 - t))))))) * 0.999999999999999876

def _fukushima_fdi_p1p5_region_6(x):
    t = 0.1 * x - 1.0
    return (1.59656593348660977e9 + t * (7.32769737561517060e9 + t * (1.42662658588280191e10 + t * (1.51238422045169918e10 + t * (9.27233604548095476e9 + t * (3.18834513406577423e9 + t * (5.36061988605886123e8 + t * 3.03619219668246382e7))))))) / (1.18906980815759995e7 + t * (2.62209219322122975e7 + t * (2.28143701746618729e7 + t * (8.57156701742181874e6 + t * (1.13860063870524239e6 + t * (27091.7884208687379 + t * (-275.664733379090447 + t))))))) * 0.999999999999999829

def _fukushima_fdi_p1p5_region_7(x):
    t = 0.05 * x - 1.0
    return (2.60437581212904589e8 + t * (1.08771546307370080e9 + t * (1.81531350939088943e9 + t * (1.52833764636304939e9 + t * (6.70684451492750149e8 + t * (1.40870639531414149e8 + t * 1.04957900377463854e7)))))) / (358448.871166784200 + t * (611808.419702466190 + t * (326307.561591723775 + t * (58407.9904827573816 + t * (2049.50040323021794 + t * (-39.8767861209088081 + t)))))) * 0.999999999999999828

def _fukushima_fdi_p1p5_region_8(x):
    factor = 2.0 / 5.0
    w = 1.0 / (x * x)
    s = 1.0 - 1600.0 * w
    return x * x * jnp.sqrt(x) * factor * (1.0 + w * (6.16739021212286242 + s * (0.00111530123694574981 + s * (-2.79156524536560815e-6 + s * (2.95571462110856359e-8 - s * 6.70917556862133933e-10)))))

def fermi_dirac_integral_three_half_fwd(x):
    return fermi_dirac_integral_three_half(x), fermi_dirac_integral_half(x)

def FD_three_halfs_bwd(res, g):
    return (res * g,)

fermi_dirac_integral_three_half.defvjp(fermi_dirac_integral_three_half_fwd, FD_three_halfs_bwd)


